name: Remove PR docker image

on:
  pull_request:
    branches:
      - main
    types:
      - closed
  workflow_call:

jobs:
  remove_pr_image:
    name: Remove PR image
    runs-on: ubuntu-latest

    steps:
      - name: Delete package
        if: github.event_name == 'pull_request'
        run: |
          echo Retriving image with tag pr-${{ github.event.number }}

          package_id=$(curl -L -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/users/sabowski/packages/container/ecobee-exporter/versions \
            | jq -r '.[] | select(.metadata.container.tags | index("pr-${{ github.event.number }}")) | .id')
          
          echo package id is ${package_id:-not found}

          echo Deleting image

          curl -L -X DELETE -s -w "%{http_code}" \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/users/sabowski/packages/container/ecobee-exporter/versions/${package_id}
